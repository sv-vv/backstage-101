# Node.js with React
# Build a Node.js project that uses React.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
  branches:
    include:
    - main 

variables:
  COMPOSE_DOCKER_CLI_BUILD: 1
  DOCKER_BUILDKIT: 1

stages:

# Build stage
- stage: BuildAndTest
  jobs:
    - job: BuildAndTest
      pool:
        vmImage: ubuntu-latest
      steps:
      # install NodeJS and Yarn
      - task: NodeTool@0
        inputs:
          versionSpec: '14.x'
        displayName: 'Install Node.js'
      - task: YarnInstaller@3
        inputs:
          versionSpec: '1.x'
          checkLatest: true
        displayName: 'Install Yarn'

      - script: |
          yarn install
          yarn tsc
          yarn test:all
          yarn build
        displayName: 'yarn install, test and build'

      - task: Docker@2
        displayName: Build a docker image
        inputs:
          command: 'build'
          Dockerfile: '**/Dockerfile'
          buildContext: '.'
          tags: |
            latest